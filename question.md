# 高并发下库存问题（秒杀环境）

## 安全的减库存
1 
mySql （只使用此方案数据库压力大，存在性能问题）
事务
更新加乐观锁 version | 
```sql
update set size = size - :num where id=:id and version=:version and size >= :num
```
2
redis 分布式锁，使用商品id加锁 缺点（并发不高，串行处理，
同一时间只有一个用户可以操作数据，体验不好）

redis 缓存商品数量库存等信息 （利用redis的increment操作原子性）
先获取到库存，
库存满足时
  进行扣除库存操作，使用increment操作，
    成功
      处理数据库库存信息 
    否则
      下单失败并加回库存
下单失败

3 队列
通过队列减少库存

超出库存的直接丢弃数据


## 重复下单问题（多次点击 网络问题等导致）

UI需要操作后按钮设置为不可提交

下单前获取一个uuid，下单时根据uuid做主键去重（存在安全性），或者是uuid保存到缓存中，
下单时判断缓存是否存在，存在则下单成功，并清除uuid的缓存，否则下单失败
